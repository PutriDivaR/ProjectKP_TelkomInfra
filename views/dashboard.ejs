<%- include('layout/header') %>
<%- include('layout/sidebar') %>
  
  <div class="main">
    
    <!-- HEADER -->
    <div class="header">
      <div>
        <h1>üìä RIDAR Dashboard</h1>
        <p>Real-time Work Order Monitoring & Analytics</p>
      </div>
      <button class="btn-refresh" id="btnRefresh">
        <span class="icon">üîÑ</span>
        Refresh Data
      </button>
    </div>

    <!-- KPI SECTION (dipulihkan) -->
    <div class="kpi-section">
      <div class="section-title">üéØ Key Performance Indicators</div>
      <div class="kpi-grid">
        <div class="kpi-card info">
          <div class="kpi-label">Total Work Orders</div>
          <div class="kpi-value"><%= totalWO %></div>
          <div class="kpi-subtitle">Semua WO dalam sistem</div>
        </div>

        <div class="kpi-card success">
          <div class="kpi-label">Complete</div>
          <div class="kpi-value">
            <%= statusDaily.find(s => s.status_daily === 'Complete')?.count || 0 %>
          </div>
          <div class="kpi-subtitle">WO yang sudah selesai</div>
        </div>

        <div class="kpi-card warning">
          <div class="kpi-label">Startwork</div>
          <div class="kpi-value">
            <%= statusDaily.find(s => s.status_daily === 'Startwork')?.count || 0 %>
          </div>
          <div class="kpi-subtitle">WO sedang dikerjakan</div>
        </div>

        <div class="kpi-card danger">
          <div class="kpi-label">Workfail</div>
          <div class="kpi-value">
            <%= statusDaily.find(s => s.status_daily === 'Workfail')?.count || 0 %>
          </div>
          <div class="kpi-subtitle">WO yang gagal</div>
        </div>
      </div>
    </div>

    <!-- WORKFALL TABLE (posisi kedua setelah KPI) -->
    <div class="kpi-section">
      <div class="section-title">üìë Work Status Distribution by STO</div>
  <div class="table-container compact">
        <div class="table-header">
          <div class="table-title">
            <span>üìä</span>
            Workfall Table - Status Daily per STO
          </div>
        </div>
        
        <div class="table-scroll">
          <table class="table-work-full">
            <thead>
              <tr>
                <th>STO</th>
                <th>Startwork</th>
                <th>Complete</th>
                <th>Workfail</th>
                <th>Total</th>
                <th>Completion %</th>
              </tr>
            </thead>
            <tbody>
              <% workfallData.forEach(row => { %>
                <% const completionRate = Number(row.total || 0) > 0 ? ((Number(row.complete || 0) / Number(row.total || 0)) * 100).toFixed(1) : 0 %>
                <tr data-completion="<%= completionRate %>">
                  <td><strong><%= row.sto %></strong></td>
                  <td><%= row.startwork %></td>
                  <td><%= row.complete %></td>
                  <td><%= row.workfail %></td>
                  <td><strong><%= row.total %></strong></td>
                  <td>
                    <div class="progress-container">
                      <div class="progress-bar">
                        <div class="progress-fill <%= completionRate >= 75 ? 'complete' : completionRate >= 50 ? 'high' : completionRate >= 25 ? 'medium' : 'low' %>" 
                             data-width="<%= completionRate %>"></div>
                      </div>
                      <span class="progress-text"><%= completionRate %>%</span>
                    </div>
                  </td>
                </tr>
              <% }) %>
              <tr>
                <td><strong>TOTAL</strong></td>
                <td><strong><%= workfallData.reduce((sum, r) => sum + Number(r.startwork || 0), 0) %></strong></td>
                <td><strong><%= workfallData.reduce((sum, r) => sum + Number(r.complete || 0), 0) %></strong></td>
                <td><strong><%= workfallData.reduce((sum, r) => sum + Number(r.workfail || 0), 0) %></strong></td>
                <td><strong><%= workfallData.reduce((sum, r) => sum + Number(r.total || 0), 0) %></strong></td>
                <td>
                  <% 
                    const wfTotalComplete = workfallData.reduce((sum, r) => sum + Number(r.complete || 0), 0);
                    const wfTotalAll = workfallData.reduce((sum, r) => sum + Number(r.total || 0), 0);
                    const wfOverallRate = wfTotalAll > 0 ? ((wfTotalComplete / wfTotalAll) * 100).toFixed(1) : 0;
                  %>
                  <strong><%= wfOverallRate %>%</strong>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- STATUS DISTRIBUTION CHARTS -->
    <div class="kpi-section">
      <div class="section-title">üìà Status Distribution</div>
      <div class="chart-grid">
        
        <!-- Status Daily Chart -->
        <div class="chart-card">
          <div class="chart-title">
            <span class="chart-icon">üîµ</span>
            Status Daily Distribution
          </div>
          <div class="chart-wrapper">
            <canvas id="chartStatusDaily" 
                    data-values='<%= JSON.stringify(statusDaily) %>'></canvas>
          </div>
        </div>

        <!-- Status Todolist Chart -->
        <div class="chart-card">
          <div class="chart-title">
            <span class="chart-icon">üìã</span>
            Status Todolist
          </div>
          <div class="chart-wrapper">
            <canvas id="chartStatusTodolist" 
                    data-values='<%= JSON.stringify(statusTodolist) %>'></canvas>
          </div>
        </div>

        <!-- Status HI Chart -->
        <div class="chart-card">
          <div class="chart-title">
            <span class="chart-icon">‚ö†Ô∏è</span>
            Status Kendala Pelanggan (HI)
          </div>
          <div class="chart-wrapper">
            <canvas id="chartStatusHI" 
                    data-values='<%= JSON.stringify(statusHI) %>'></canvas>
          </div>
        </div>

  

      </div>
    </div>

    <!-- PERFORMANCE CHARTS -->
    <div class="kpi-section">
      <div class="section-title">üèÜ Performance Analytics</div>
      <div class="chart-grid">
        
        <!-- Top STO -->
        <div class="chart-card">
          <div class="chart-title">
            <span class="chart-icon">ü•á</span>
            Top 10 STO by WO Count
          </div>
          <div class="chart-wrapper tall">
            <canvas id="chartTopSTO" 
                    data-values='<%= JSON.stringify(topSTO) %>'></canvas>
          </div>
        </div>

        <!-- Daily Trend -->
        <div class="chart-card">
          <div class="chart-title">
            <span class="chart-icon">üìä</span>
            WO Trend (Last 30 Days)
          </div>
          <div class="chart-wrapper tall">
            <canvas id="chartDailyTrend" 
                    data-values='<%= JSON.stringify(dailyTrend) %>'></canvas>
          </div>
        </div>

      </div>
    </div>

    <!-- TECHNICAL CHARTS -->
    <div class="kpi-section">
      <div class="section-title">üîß Technical Distribution</div>
      <div class="chart-grid">
        
        <!-- Activity Teknisi -->
        <div class="chart-card">
          <div class="chart-title">
            <span class="chart-icon">üë∑</span>
            Top Activity Teknisi
          </div>
          <div class="chart-wrapper">
            <canvas id="chartActivityTech" 
                    data-values='<%= JSON.stringify(activityTech) %>'></canvas>
          </div>
        </div>

        

        <!-- Segment Distribution -->
        <div class="chart-card">
          <div class="chart-title">
            <span class="chart-icon">üéØ</span>
            Segment Distribution
          </div>
          <div class="chart-wrapper">
            <canvas id="chartSegment" 
                    data-values='<%= JSON.stringify(segmentDist) %>'></canvas>
          </div>
        </div>

                <!-- Package Distribution -->
        <div class="chart-card">
          <div class="chart-title">
            <span class="chart-icon">üì¶</span>
            Package Distribution
          </div>
          <div class="chart-wrapper">
            <canvas id="chartPackage" 
                    data-values='<%= JSON.stringify(packageDist) %>'></canvas>
          </div>
        </div>

      </div>
    </div>

        

      </div>
    </div>

    

    <!-- STO INFORMATION TABLE -->
    <div class="kpi-section">
      <div class="section-title">üè¢ STO Information & Team</div>
      <div class="table-container">
        <div class="table-header">
          <div class="table-title">
            <span>üë•</span>
            STO Details with Team Information
          </div>
        </div>
        
        <div class="table-scroll">
          <table data-paginate data-perpage="10">
            <thead>
              <tr>
                <th>STO</th>
                <th>UIC</th>
                <th>PIC</th>
                <th>Leader</th>
                <th>Total WO</th>
                <th>Completed</th>
                <th>Performance</th>
              </tr>
            </thead>
            <tbody>
              <% stoInfo.forEach(sto => { %>
                <% const perfRate = sto.total_wo > 0 ? ((Number(sto.completed_wo || 0) / Number(sto.total_wo || 0)) * 100).toFixed(1) : 0 %>
                <tr data-perf="<%= perfRate %>">
                  <td><strong><%= sto.sto %></strong></td>
                  <td><%= sto.uic %></td>
                  <td><%= sto.pic %></td>
                  <td><%= sto.leader %></td>
                  <td><%= sto.total_wo %></td>
                  <td><%= sto.completed_wo %></td>
                  <td>
                    <div class="progress-container">
                      <div class="progress-bar">
                        <div class="progress-fill <%= perfRate >= 75 ? 'complete' : perfRate >= 50 ? 'high' : perfRate >= 25 ? 'medium' : 'low' %>" 
                             data-width="<%= perfRate %>"></div>
                      </div>
                      <span class="progress-text"><%= perfRate %>%</span>
                    </div>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- RECENT ACTIVITIES TABLE -->
    <div class="kpi-section">
      <div class="section-title">üïê Recent Work Orders</div>
      <div class="table-container">
        <div class="table-header">
          <div class="table-title">
            <span>‚ö°</span>
            Latest 20 WO Activities
          </div>
        </div>
        
        <div class="table-scroll">
          <table data-paginate data-perpage="10">
            <thead>
              <tr>
                <th>WO Number</th>
                <th>Customer Name</th>
                <th>STO</th>
                <th>Status</th>
                <th>Activity</th>
                <th>Created At</th>
              </tr>
            </thead>
            <tbody>
              <% recentWO.forEach(wo => { %>
                <tr>
                  <td><strong><%= wo.wonum %></strong></td>
                  <td><%= wo.nama %></td>
                  <td><%= wo.sto %></td>
                  <td>
                    <span class="status-badge status-<%= wo.status_daily ? wo.status_daily.toLowerCase().replace(' ', '_') : 'default' %>">
                      <%= wo.status_daily || 'N/A' %>
                    </span>
                  </td>
                  <td style="font-size: 11px;"><%= wo.odp_todolist || '-' %></td>
                  <td>
                    <%= new Date(wo.created_at).toLocaleDateString('id-ID', { 
                      year: 'numeric', 
                      month: 'short', 
                      day: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit'
                    }) %>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  
<%- include('layout/footer') %>