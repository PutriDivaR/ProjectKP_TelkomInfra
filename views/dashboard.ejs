<%- include('layout/header') %>
<%- include('layout/sidebar') %>
  
  <div class="main">
    
    <!-- HEADER -->
    <div class="header">
      <div>
        <h1>üìä RIDAR Dashboard</h1>
        <p>Real-time Work Order Monitoring & Analytics</p>
      </div>
      <div style="display: flex; gap: 12px; align-items: center;">
        <button class="btn-refresh" id="btnRefresh">
          <span class="icon">üîÑ</span>
          Refresh Data
        </button>
      </div>
    </div>

    <!-- FILTER & EXPORT PANEL -->
    <div class="filter-panel">
      <div class="filter-header">
        <div class="filter-title">
          <span>üîç</span>
          Filter & Export Data
        </div>
        <button class="btn-toggle-filter" id="btnToggleFilter">
          <span id="filterToggleIcon">‚ñº</span>
        </button>
      </div>
      
      <div class="filter-content" id="filterContent">
        <form id="filterForm" class="filter-form">
          <div class="filter-row">
            <!-- Search -->
            <div class="filter-group">
              <label>üîé Search WO/Nama</label>
              <input type="text" name="search" class="filter-input" 
                     placeholder="WO Number atau Nama Pelanggan" 
                     value="<%= filters.search %>">
            </div>

            <!-- STO Filter -->
            <div class="filter-group">
              <label>üìç STO</label>
              <select name="sto_filter" class="filter-select">
                <option value="">-- Semua STO --</option>
                <% stoList.forEach(item => { %>
                  <option value="<%= item.sto %>" <%= filters.sto_filter === item.sto ? 'selected' : '' %>>
                    <%= item.sto %>
                  </option>
                <% }) %>
              </select>
            </div>

            <!-- Regional Filter -->
            <div class="filter-group">
              <label>üåè Regional</label>
              <select name="regional_filter" class="filter-select">
                <option value="">-- Semua Regional --</option>
                <% regionalList.forEach(item => { %>
                  <option value="<%= item.regional %>" <%= filters.regional_filter === item.regional ? 'selected' : '' %>>
                    <%= item.regional %>
                  </option>
                <% }) %>
              </select>
            </div>

            <!-- Status Filter -->
            <div class="filter-group">
              <label>üìä Status Daily</label>
              <select name="status_filter" class="filter-select">
                <option value="">-- Semua Status --</option>
                <% statusList.forEach(item => { %>
                  <option value="<%= item.status_daily %>" <%= filters.status_filter === item.status_daily ? 'selected' : '' %>>
                    <%= item.status_daily %>
                  </option>
                <% }) %>
              </select>
            </div>
          </div>

          <div class="filter-row">
            <!-- Date From -->
            <div class="filter-group">
              <label>üìÖ Tanggal Dari</label>
              <input type="date" name="date_from" class="filter-input" 
                     value="<%= filters.date_from %>">
            </div>

            <!-- Date To -->
            <div class="filter-group">
              <label>üìÖ Tanggal Sampai</label>
              <input type="date" name="date_to" class="filter-input" 
                     value="<%= filters.date_to %>">
            </div>

            <!-- Filter Buttons -->
            <div class="filter-group" style="flex: 2;">
              <label>&nbsp;</label>
              <div class="filter-buttons">
                <button type="submit" class="btn-apply-filter">
                  <span>‚úì</span> Terapkan Filter
                </button>
                <button type="button" class="btn-clear-filter" id="btnClearFilters">
                  <span>‚úï</span> Reset
                </button>
              </div>
            </div>
          </div>
        </form>

        <!-- Export Buttons -->
        <div class="export-section">
          <div class="export-label">
            <span>üì•</span> Ekspor Laporan:
          </div>
          <div class="export-buttons">
            <button class="btn-export btn-export-pdf" id="btnExportPDF">
              <span>üìÑ</span> Export PDF
            </button>
            <button class="btn-export btn-export-excel" id="btnExportExcel">
              <span>üìä</span> Export Excel
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ACTIVE FILTERS DISPLAY -->
    <% 
      const hasActiveFilters = filters.search || filters.sto_filter || filters.regional_filter || 
                               filters.status_filter || filters.date_from || filters.date_to;
    %>
    <% if (hasActiveFilters) { %>
    <div class="active-filters">
      <div class="active-filters-title">üè∑Ô∏è Filter Aktif:</div>
      <div class="active-filters-tags">
        <% if (filters.search) { %>
          <span class="filter-tag">Search: <%= filters.search %></span>
        <% } %>
        <% if (filters.sto_filter) { %>
          <span class="filter-tag">STO: <%= filters.sto_filter %></span>
        <% } %>
        <% if (filters.regional_filter) { %>
          <span class="filter-tag">Regional: <%= filters.regional_filter %></span>
        <% } %>
        <% if (filters.status_filter) { %>
          <span class="filter-tag">Status: <%= filters.status_filter %></span>
        <% } %>
        <% if (filters.date_from) { %>
          <span class="filter-tag">Dari: <%= filters.date_from %></span>
        <% } %>
        <% if (filters.date_to) { %>
          <span class="filter-tag">Sampai: <%= filters.date_to %></span>
        <% } %>
      </div>
    </div>
    <% } %>

    <!-- KPI SECTION -->
    <div class="kpi-section">
      <div class="section-title">üéØ Key Performance Indicators</div>
      <div class="kpi-grid">
        <div class="kpi-card info">
          <div class="kpi-label">Total Work Orders</div>
          <div class="kpi-value"><%= totalWO %></div>
          <div class="kpi-subtitle">Semua WO dalam sistem</div>
        </div>

        <div class="kpi-card success">
          <div class="kpi-label">Complete</div>
          <div class="kpi-value">
            <%= statusDaily.find(s => s.status_daily === 'Complete')?.count || 0 %>
          </div>
          <div class="kpi-subtitle">WO yang sudah selesai</div>
        </div>

        <div class="kpi-card warning">
          <div class="kpi-label">Startwork</div>
          <div class="kpi-value">
            <%= statusDaily.find(s => s.status_daily === 'Startwork')?.count || 0 %>
          </div>
          <div class="kpi-subtitle">WO sedang dikerjakan</div>
        </div>

        <div class="kpi-card danger">
          <div class="kpi-label">Workfail</div>
          <div class="kpi-value">
            <%= statusDaily.find(s => s.status_daily === 'Workfail')?.count || 0 %>
          </div>
          <div class="kpi-subtitle">WO yang gagal</div>
        </div>

        <div class="kpi-card info">
          <div class="kpi-label">Completion Rate</div>
          <div class="kpi-value">
            <% 
              const totalComplete = statusDaily.find(s => s.status_daily === 'Complete')?.count || 0;
              const completionRate = totalWO > 0 ? ((totalComplete / totalWO) * 100).toFixed(1) : 0;
            %>
            <%= completionRate %>%
          </div>
          <div class="kpi-subtitle">Persentase penyelesaian</div>
        </div>
      </div>
    </div>

    <!-- WORKFALL TABLE -->
    <div class="kpi-section">
      <div class="section-title">üìë Work Status Distribution by STO</div>
      <div class="table-container compact">
        <div class="table-header">
          <div class="table-title">
            <span>üìä</span>
            Workfall Table - Status Daily per STO
          </div>
        </div>
        
        <div class="table-scroll">
          <table class="table-work-full">
            <thead>
              <tr>
                <th>STO</th>
                <th>Startwork</th>
                <th>Complete</th>
                <th>Workfail</th>
                <th>Total</th>
                <th>Completion %</th>
              </tr>
            </thead>
            <tbody>
              <% workfallData.forEach(row => { %>
                <% const completionRate = Number(row.total || 0) > 0 ? ((Number(row.complete || 0) / Number(row.total || 0)) * 100).toFixed(1) : 0 %>
                <tr data-completion="<%= completionRate %>">
                  <td><strong><%= row.sto %></strong></td>
                  <td><%= row.startwork %></td>
                  <td><%= row.complete %></td>
                  <td><%= row.workfail %></td>
                  <td><strong><%= row.total %></strong></td>
                  <td>
                    <div class="progress-container">
                      <div class="progress-bar">
                        <div class="progress-fill <%= completionRate >= 75 ? 'complete' : completionRate >= 50 ? 'high' : completionRate >= 25 ? 'medium' : 'low' %>" 
                             data-width="<%= completionRate %>"></div>
                      </div>
                      <span class="progress-text"><%= completionRate %>%</span>
                    </div>
                  </td>
                </tr>
              <% }) %>
              <tr>
                <td><strong>TOTAL</strong></td>
                <td><strong><%= workfallData.reduce((sum, r) => sum + Number(r.startwork || 0), 0) %></strong></td>
                <td><strong><%= workfallData.reduce((sum, r) => sum + Number(r.complete || 0), 0) %></strong></td>
                <td><strong><%= workfallData.reduce((sum, r) => sum + Number(r.workfail || 0), 0) %></strong></td>
                <td><strong><%= workfallData.reduce((sum, r) => sum + Number(r.total || 0), 0) %></strong></td>
                <td>
                  <% 
                    const wfTotalComplete = workfallData.reduce((sum, r) => sum + Number(r.complete || 0), 0);
                    const wfTotalAll = workfallData.reduce((sum, r) => sum + Number(r.total || 0), 0);
                    const wfOverallRate = wfTotalAll > 0 ? ((wfTotalComplete / wfTotalAll) * 100).toFixed(1) : 0;
                  %>
                  <strong><%= wfOverallRate %>%</strong>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- STATUS DISTRIBUTION CHARTS -->
    <div class="kpi-section">
      <div class="section-title">üìà Status Distribution</div>
      <div class="chart-grid">
        
        <!-- Status Daily Chart -->
        <div class="chart-card">
          <div class="chart-title">
            <span class="chart-icon">üîµ</span>
            Status Daily Distribution
          </div>
          <div class="chart-wrapper">
            <canvas id="chartStatusDaily" 
                    data-values='<%= JSON.stringify(statusDaily) %>'></canvas>
          </div>
        </div>

        <!-- Status Todolist Chart -->
        <div class="chart-card">
          <div class="chart-title">
            <span class="chart-icon">üìã</span>
            Status Todolist
          </div>
          <div class="chart-wrapper">
            <canvas id="chartStatusTodolist" 
                    data-values='<%= JSON.stringify(statusTodolist) %>'></canvas>
          </div>
        </div>

        <!-- Status HI Chart -->
        <div class="chart-card">
          <div class="chart-title">
            <span class="chart-icon">‚ö†Ô∏è</span>
            Status Kendala Pelanggan (HI)
          </div>
          <div class="chart-wrapper">
            <canvas id="chartStatusHI" 
                    data-values='<%= JSON.stringify(statusHI) %>'></canvas>
          </div>
        </div>

      </div>
    </div>

    <!-- PERFORMANCE CHARTS -->
    <div class="kpi-section">
      <div class="section-title">üèÜ Performance Analytics</div>
      <div class="chart-grid">
        
        <!-- Top STO -->
        <div class="chart-card">
          <div class="chart-title">
            <span class="chart-icon">ü•á</span>
            Top 10 STO by WO Count
          </div>
          <div class="chart-wrapper tall">
            <canvas id="chartTopSTO" 
                    data-values='<%= JSON.stringify(topSTO) %>'></canvas>
          </div>
        </div>

        <!-- Daily Trend -->
        <div class="chart-card">
          <div class="chart-title">
            <span class="chart-icon">üìä</span>
            WO Trend (Last 30 Days)
          </div>
          <div class="chart-wrapper tall">
            <canvas id="chartDailyTrend" 
                    data-values='<%= JSON.stringify(dailyTrend) %>'></canvas>
          </div>
        </div>

        <!-- NEW: Completion Rate Trend -->
        <div class="chart-card">
          <div class="chart-title">
            <span class="chart-icon">‚úÖ</span>
            Completion Rate Trend (30 Days)
          </div>
          <div class="chart-wrapper tall">
            <canvas id="chartCompletionTrend" 
                    data-values='<%= JSON.stringify(completionTrend) %>'></canvas>
          </div>
        </div>

      </div>
    </div>

    <!-- TECHNICAL CHARTS -->
    <div class="kpi-section">
      <div class="section-title">üîß Technical Distribution</div>
      <div class="chart-grid">
        
        <!-- Activity Teknisi -->
        <div class="chart-card">
          <div class="chart-title">
            <span class="chart-icon">üë∑</span>
            Top Activity Teknisi
          </div>
          <div class="chart-wrapper">
            <canvas id="chartActivityTech" 
                    data-values='<%= JSON.stringify(activityTech) %>'></canvas>
          </div>
        </div>

        <!-- Package Distribution -->
        <div class="chart-card">
          <div class="chart-title">
            <span class="chart-icon">üì¶</span>
            Package Distribution
          </div>
          <div class="chart-wrapper">
            <canvas id="chartPackage" 
                    data-values='<%= JSON.stringify(packageDist) %>'></canvas>
          </div>
        </div>

        <!-- Segment Distribution removed -->

        <!-- NEW: TTD KB Distribution -->
        <div class="chart-card">
          <div class="chart-title">
            <span class="chart-icon">‚è±Ô∏è</span>
            Trouble Ticket Duration (TTD KB)
          </div>
          <div class="chart-wrapper">
            <canvas id="chartTTD" 
                    data-values='<%= JSON.stringify(ttdDistribution) %>'></canvas>
          </div>
        </div>

      </div>
    </div>

    <!-- STO INFORMATION TABLE -->
    <div class="kpi-section">
      <div class="section-title">üè¢ STO Information & Team</div>
      <div class="table-container">
        <div class="table-header">
          <div class="table-title">
            <span>üë•</span>
            STO Details with Team Information
          </div>
          <div class="table-scroll-btn">
            <button class="btn-scroll-left">‚Üê</button>
            <button class="btn-scroll-right">‚Üí</button>
          </div>
        </div>
        
        <div class="table-scroll">
          <table data-paginate data-perpage="10">
            <thead>
              <tr>
                <th>STO</th>
                <th>UIC</th>
                <th>PIC</th>
                <th>Leader</th>
                <th>Total WO</th>
                <th>Completed</th>
                <th>Completion %</th>
              </tr>
            </thead>
            <tbody>
              <% stoInfo.forEach(row => { %>
                <% 
                  const stoCompletionRate = Number(row.total_wo || 0) > 0 
                    ? ((Number(row.completed_wo || 0) / Number(row.total_wo || 0)) * 100).toFixed(1) 
                    : 0;
                %>
                <tr>
                  <td><strong><%= row.sto %></strong></td>
                  <td><%= row.uic %></td>
                  <td><%= row.pic %></td>
                  <td><%= row.leader %></td>
                  <td><%= row.total_wo %></td>
                  <td><%= row.completed_wo %></td>
                  <td>
                    <div class="progress-container">
                      <div class="progress-bar">
                        <div class="progress-fill <%= stoCompletionRate >= 75 ? 'complete' : stoCompletionRate >= 50 ? 'high' : stoCompletionRate >= 25 ? 'medium' : 'low' %>" 
                             data-width="<%= stoCompletionRate %>"></div>
                      </div>
                      <span class="progress-text"><%= stoCompletionRate %>%</span>
                    </div>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- RECENT WO ACTIVITIES -->
    <div class="kpi-section">
      <div class="section-title">üïí Recent Work Order Activities</div>
      <div class="table-container">
        <div class="table-header">
          <div class="table-title">
            <span>üìù</span>
            Latest Work Orders
          </div>
        </div>
        
        <div class="table-scroll">
          <table data-paginate data-perpage="10">
            <thead>
              <tr>
                <th>WO Number</th>
                <th>Nama Pelanggan</th>
                <th>STO</th>
                <th>Status Daily</th>
                <th>ODP Todolist</th>
                <th>Created At</th>
              </tr>
            </thead>
            <tbody>
              <% recentWO.forEach(wo => { %>
                <tr>
                  <td><strong><%= wo.wonum %></strong></td>
                  <td><%= wo.nama %></td>
                  <td><%= wo.sto %></td>
                  <td>
                    <span class="status-badge status-<%= (wo.status_daily || '').toLowerCase().replace(/\s+/g, '') %>">
                      <%= wo.status_daily || 'N/A' %>
                    </span>
                  </td>
                  <td><%= wo.odp_todolist || '-' %></td>
                  <td><%= new Date(wo.created_at).toLocaleString('id-ID') %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- jsPDF for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<!-- SheetJS for Excel export -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<!-- Custom Dashboard Script -->
<script src="/js/dashboard.js"></script>

<!-- Filter Toggle Script -->
<script>
document.getElementById('btnToggleFilter')?.addEventListener('click', function() {
  const content = document.getElementById('filterContent');
  const icon = document.getElementById('filterToggleIcon');
  
  if (content.style.display === 'none' || content.style.display === '') {
    content.style.display = 'block';
    icon.textContent = '‚ñ≤';
  } else {
    content.style.display = 'none';
    icon.textContent = '‚ñº';
  }
});
</script>

<%- include('layout/footer') %>
