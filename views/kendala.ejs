<%- include('layout/header', { title: 'Kendala Pelanggan' }) %>
<%- include('layout/sidebar') %>
<link rel="stylesheet" href="/css/kendala.css">

<div class="main">
  <div class="kendala-container">

  <!-- TOPBAR -->
  <div class="header">
    <h2>KENDALA PELANGGAN</h2>
    <div class="topbar-right">
      <span class="admin-label"><%= user && user.username ? user.username : 'Nama Admin' %></span>
    </div>
  </div>

  <!-- SUB HEADER -->
  <% if (mode === 'rekap') { %>
  <div class="sub-header">
    <h3 class="sub-title">Data Kendala Pelanggan</h3>
  </div>
  <% } %>

  <% if (mode === 'rekap') { %>
    <% if (typeof saved !== 'undefined' && saved) { %>
    <div class="alert alert-success" id="successAlert">
      Data berhasil disimpan dan masuk ke rekapan.
      <% if (typeof warningWonum !== 'undefined' && warningWonum) { %>
      <span class="alert-warning-text">Catatan: WONUM belum terdaftar di Master WO.</span>
      <% } %>
    </div>
    <% } %>
    <div class="rekap-card">
      <div class="rekap-card-header">
        <a href="/kendala/input" class="btn-input-data"><i class="fa-solid fa-plus"></i> Input Data</a>
      </div>
      <hr class="rekap-divider">
      <div class="rekap-summary">
        <div class="summary-card summary-progress">
          <span class="summary-label">Progress</span>
          <span class="summary-value"><%= countProgress || 0 %></span>
        </div>
        <div class="summary-card summary-reject">
          <span class="summary-label">Reject</span>
          <span class="summary-value"><%= countReject || 0 %></span>
        </div>
        <div class="summary-card summary-closed">
          <span class="summary-label">Closed</span>
          <span class="summary-value"><%= countClosed || 0 %></span>
        </div>
      </div>
    </div>


    <!-- *Perubahan*-->
<div class="rekap-toolbar">
  <form method="GET" action="/kendala" class="filter-form">
    <div class="filter-field search-field">
      <i class="fa-solid fa-magnifying-glass search-icon"></i>
      <input type="text" name="q" placeholder="Cari WONUM / Ticket ID" value="<%= typeof q !== 'undefined' ? (q || '') : '' %>" class="search-input" id="searchWonum">
    </div>

    <select name="status" class="filter-input">
      <option value="">Status HI (All)</option>
      <option value="PROGRESS" <%= status === 'PROGRESS' ? 'selected' : '' %>>PROGRESS</option>
      <option value="REJECT" <%= status === 'REJECT' ? 'selected' : '' %>>REJECT</option>
      <option value="CLOSED" <%= status === 'CLOSED' ? 'selected' : '' %>>CLOSED</option>
    </select>

    <select name="sto" class="filter-input">
      <option value="">STO (All)</option>
      <% if (typeof listSto !== 'undefined' && listSto && listSto.length) { %>
        <% listSto.forEach(function(s) { %>
          <option value="<%= s %>" <%= sto === s ? 'selected' : '' %>><%= s %></option>
        <% }); %>
      <% } %>
    </select>

    <select name="ttic" class="filter-input">
      <option value="">TTIC (All)</option>
      <% if (typeof listTtic !== 'undefined' && listTtic && listTtic.length) { %>
        <% listTtic.forEach(function(t) { %>
          <option value="<%= t %>" <%= ttic === t ? 'selected' : '' %>><%= t %></option>
        <% }); %>
      <% } %>
    </select>

    <input type="date" name="date" class="filter-input" value="<%= date || '' %>" title="Tanggal">

    <select name="per_page" class="filter-input">
      <option value="25" <%= perPage === 25 ? 'selected' : '' %>>25 / page</option>
      <option value="50" <%= perPage === 50 ? 'selected' : '' %>>50 / page</option>
      <option value="100" <%= perPage === 100 ? 'selected' : '' %>>100 / page</option>
    </select>

    <button type="submit" class="btn-input-data"><i class="fa-solid fa-filter"></i> Filter</button>
    <a href="/kendala" class="btn-kembali">Reset</a>
  </form>

  <!-- EXPORT SECTION -->
  <div class="export-controls">
    <select id="exportType" class="filter-input">
      <option value="">Export</option>
      <option value="pdf">PDF</option>
      <option value="excel">Excel</option>
    </select>
    <button type="button" id="btnExport" class="btn-input-data">
      <i class="fa-solid fa-file-export"></i> Export
    </button>
  </div>
</div>


    <div class="table-wrapper">
      <table class="kendala-table rekap-table">
        <thead>
          <tr>
            <th>NO</th>
            <th>WONUM</th>
            <th>STATUS HI</th>
            <th>STO</th>
            <th>TTD KB</th>
            <th>TTIC</th>
            <th>INPUT DATE</th>
            <th>AKSI</th>
          </tr>
        </thead>
        <tbody>
          <% const list = typeof filteredData !== 'undefined' ? filteredData : data; %>
          <% if (!list || list.length === 0) { %>
            <tr>
              <td colspan="8" class="empty-row">Tidak ada data</td>
            </tr>
          <% } else { %>
            <% list.forEach((d, i) => { %>
              <tr data-id="<%= d.id %>" data-wonum="<%= d.wonum %>" data-ticket_id="<%= d.ticket_id || '' %>" data-status_hi="<%= d.status_hi || '' %>" data-sto="<%= d.sto || '' %>" data-ttd_kb="<%= d.ttd_kb || '' %>" data-ttic="<%= d.ttic || '' %>" data-keterangan="<%= (d.keterangan || '').replace(/"/g, '&quot;') %>" data-created_at="<%= d.created_at ? new Date(d.created_at).toISOString() : '' %>" data-updated_at="<%= d.updated_at ? new Date(d.updated_at).toISOString() : '' %>" data-nama_teknis="<%= d.nama_teknis || '' %>">
                <td><%= (currentPage - 1) * (perPage || 50) + i + 1 %></td>

                <td><%= d.wonum %></td>
                <td><%= d.status_hi %></td>
                <td><%= d.sto || '-' %></td>
                <td><%= d.ttd_kb || '-' %></td>
                <td><%= d.ttic || '-' %></td>
                <td><%= d.updated_at ? new Date(d.updated_at).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'medium' }).replace(/\./g, '-') : (d.created_at ? new Date(d.created_at).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'medium' }).replace(/\./g, '-') : '-') %></td>
                <td>
                  <button type="button" class="btn-view btn-detail" title="Detail"><i class="fa-solid fa-eye"></i></button>
                  <button type="button" class="btn-delete" title="Hapus"><i class="fa-solid fa-trash"></i></button>
                </td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>

    <!-- *tambahan* -->
    <!-- PAGINATION -->
<% if (typeof totalPages !== 'undefined' && totalPages > 1) { %>
<div style="margin-top:20px; display:flex; justify-content:center; gap:5px; flex-wrap:wrap;">

  <% if (currentPage > 1) { %>
    <a class="page-link btn-kembali" href="/kendala?page=<%= currentPage - 1 %><%= queryString ? '&' + queryString : '' %>">
      &laquo;
    </a>
  <% } %>

  <% for (let p = 1; p <= totalPages; p++) { %>
    <a class="page-link <%= p === currentPage ? 'btn-input-data' : 'btn-kembali' %>"
       href="/kendala?page=<%= p %><%= queryString ? '&' + queryString : '' %>">
       <%= p %>
    </a>
  <% } %>

  <% if (currentPage < totalPages) { %>
    <a class="page-link btn-kembali" href="/kendala?page=<%= currentPage + 1 %><%= queryString ? '&' + queryString : '' %>">
      &raquo;
    </a>
  <% } %>

</div>
<% } %>
 

  <% } %>

  <% if (mode === 'input') { %>
  <h3 class="section-title">Input Kendala Pelanggan</h3>
  <div class="form-card">
    <% if (typeof errorWonum !== 'undefined' && errorWonum) { %>
    <div class="alert alert-error">
      WONUM tidak terdaftar di Master WO. Pastikan WONUM sudah ada di Master WO atau isi form di bawah (termasuk Ticket ID jika perlu) lalu simpanâ€”sistem akan mendaftarkan WO baru ke Master WO.
      <% if (typeof errorMsg !== 'undefined' && errorMsg) { %><br><small>Detail: <%= errorMsg %></small><% } %>
    </div>
    <% } %>
    <% if (typeof errorWonumInvalid !== 'undefined' && errorWonumInvalid) { %>
    <div class="alert alert-error">
      Format WONUM tidak valid. <%= typeof errorMsg !== 'undefined' && errorMsg ? errorMsg : '' %>
    </div>
    <% } %>
    <% if (typeof errorWonumDuplicate !== 'undefined' && errorWonumDuplicate) { %>
    <div class="alert alert-error">
      <%= typeof errorMsg !== 'undefined' && errorMsg ? errorMsg : 'WONUM sudah ada.' %>
    </div>
    <% } %>
    <% if (typeof errorWonumKosong !== 'undefined' && errorWonumKosong) { %>
    <div class="alert alert-error">WONUM tidak boleh kosong.</div>
    <% } %>
    <% if (typeof errorSaveFailed !== 'undefined' && errorSaveFailed) { %>
    <div class="alert alert-error">
      Gagal menyimpan. <% if (typeof errorMsg !== 'undefined' && errorMsg) { %><br><small><%= errorMsg %></small><% } %>
    </div>
    <% } %>
    <form method="POST" action="/kendala/input" class="kendala-form input-form">
      <div class="form-row form-row-inline">
        <div class="form-group">
          <label>WONUM</label>
          <input type="text" name="wonum" placeholder="Contoh: WO0334000001" required>
          <small style="color: #666; margin-top: 4px;">Format: WO diikuti 10 digit angka</small>
        </div>
        <div class="form-group">
          <label>STO</label>
          <select name="sto">
            <option value="">-- Pilih STO --</option>
            <% if (typeof listSto !== 'undefined' && listSto && listSto.length) { %>
              <% listSto.forEach(function(s) { %>
            <option value="<%= s %>"><%= s %></option>
              <% }); %>
            <% } %>
          </select>
        </div>
        <div class="form-group">
          <label>Tanggal Input</label>
          <input type="date" name="tanggal_input" id="tanggal_input" required>
        </div>
        <div class="form-group">
          <label>TTD KB</label>
          <input type="text" name="ttd_kb" placeholder="Contoh: 90 Hari">
        </div>
        <div class="form-group">
          <label>Status HI</label>
          <select name="status_hi">
            <option value="PROGRESS">PROGRESS</option>
            <option value="REJECT">REJECT</option>
          </select>
        </div>
        <div class="form-group">
          <label>TTIC</label>
          <select name="ttic">
            <option value="">-- Pilih TTIC --</option>
            <option value="1x24 Jam">1x24 Jam</option>
            <option value="2x24 Jam">2x24 Jam</option>
            <option value="3x24 Jam">3x24 Jam</option>
            <option value="> 3x24 Jam">&gt; 3x24 Jam</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group form-group-full">
          <label>Keterangan</label>
          <textarea name="keterangan" rows="3" placeholder="Masukkan keterangan"></textarea>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Nama Teknisi</label>
          <input type="text" name="nama_teknis" placeholder="Nama teknisi">
        </div>
      </div>
      <div class="form-action">
        <button type="submit" class="btn-simpan"><i class="fa-solid fa-pencil"></i> Simpan</button>
        <a href="/kendala" class="btn-kembali"><i class="fa-solid fa-arrow-left"></i> Kembali</a>
      </div>
    </form>
  </div>
  <% } %>

  <% if (mode === 'edit') { %>
  <h3 class="section-title">Edit Data Kendala</h3>
  <% if (typeof errorMsg !== 'undefined' && errorMsg) { %>
  <div class="alert alert-error">
    <%= errorMsg %>
  </div>
  <% } %>
  <div class="form-card detail-card">
    <form method="POST" action="/kendala/edit/<%= kendala.id %>" class="kendala-form detail-form">
      <div class="detail-two-col">
        <div class="detail-col">
          <div class="detail-field">
            <label>Workorder Number :</label>
            <input type="text" class="detail-input" value="<%= kendala.wonum %>" readonly>
          </div>
          <div class="detail-field">
            <label>Ticket Id :</label>
            <input type="text" class="detail-input" value="<%= kendala.ticket_id || '-' %>" readonly>
          </div>
          <div class="detail-field">
            <label>TTD KB :</label>
            <input type="text" class="detail-input" name="ttd_kb" value="<%= kendala.ttd_kb || '' %>" placeholder="Contoh: 90 Hari">
          </div>
          <div class="detail-field">
            <label>TTIC :</label>
            <select name="ttic" class="detail-input detail-select">
              <option value="1x24 Jam" <%= (kendala.ttic || '') === '1x24 Jam' ? 'selected' : '' %>>1x24 Jam</option>
              <option value="2x24 Jam" <%= (kendala.ttic || '') === '2x24 Jam' ? 'selected' : '' %>>2x24 Jam</option>
              <option value="3x24 Jam" <%= (kendala.ttic || '') === '3x24 Jam' ? 'selected' : '' %>>3x24 Jam</option>
              <option value="> 3x24 Jam" <%= (kendala.ttic || '') === '> 3x24 Jam' ? 'selected' : '' %>>&gt; 3x24 Jam</option>
            </select>
          </div>
          <div class="detail-field">
            <label>Keterangan :</label>
            <input type="text" class="detail-input" name="keterangan" value="<%= kendala.keterangan || '' %>">
          </div>
        </div>
        <div class="detail-col">
          <div class="detail-field">
            <label>STO :</label>
            <select name="sto" class="detail-input detail-select">
              <option value="">-- Pilih STO --</option>
              <% if (typeof listSto !== 'undefined' && listSto && listSto.length) { %>
                <% listSto.forEach(function(s) { %>
              <option value="<%= s %>" <%= (kendala.sto || '') === s ? 'selected' : '' %>><%= s %></option>
                <% }); %>
              <% } %>
            </select>
          </div>
          <div class="detail-field">
            <label>Nama Teknisi :</label>
            <input type="text" class="detail-input" name="nama_teknis" value="<%= kendala.nama_teknis || '' %>">
          </div>
          <div class="detail-field">
            <label>Status HI :</label>
            <select name="status_hi" class="detail-input detail-select">
              <option value="PROGRESS" <%= kendala.status_hi === 'PROGRESS' ? 'selected' : '' %>>PROGRESS</option>
              <option value="REJECT" <%= kendala.status_hi === 'REJECT' ? 'selected' : '' %>>REJECT</option>
              <option value="CLOSED" <%= kendala.status_hi === 'CLOSED' ? 'selected' : '' %>>CLOSED</option>
            </select>
          </div>
          <div class="detail-field">
            <label>Last Updated :</label>
            <input type="text" class="detail-input" value="<%= kendala.updated_at ? new Date(kendala.updated_at).toLocaleString('id-ID') : (kendala.created_at ? new Date(kendala.created_at).toLocaleString('id-ID') : '-') %>" readonly>
          </div>
        </div>
      </div>
      <div class="form-action detail-action">
        <button type="submit" class="btn-input-submit">
          <i class="fa-solid fa-pencil"></i> Simpan
        </button>
        <a href="/kendala" class="btn-kembali"><i class="fa-solid fa-arrow-left"></i> Kembali</a>
      </div>
    </form>
  </div>
  <% } %>

</div>
</div>

<script src="/js/kendala.js"></script>

<!-- Detail Modal -->
<div id="kendalaDetailModal" class="modal">
  <div class="modal-content">
    <span id="modalClose" class="modal-close">&times;</span>
    <h3>Detail Kendala</h3>
    <div class="detail-list">
      <p><strong>WONUM:</strong> <span id="md-wonum"></span></p>
      <p><strong>Ticket ID:</strong> <span id="md-ticket"></span></p>
      <p><strong>Status HI:</strong> <span id="md-status"></span></p>
      <p><strong>STO:</strong> <span id="md-sto"></span></p>
      <p><strong>TTD KB:</strong> <span id="md-ttd"></span></p>
      <p><strong>TTIC:</strong> <span id="md-ttic"></span></p>
      <p><strong>Keterangan:</strong> <span id="md-keterangan"></span></p>
      <p><strong>Last Updated:</strong> <span id="md-created"></span></p>
      <p><strong>Nama Teknisi:</strong> <span id="md-nama"></span></p>
    </div>
    <div class="modal-actions">
      <a id="md-edit-link" href="#" class="btn-input-data"><i class="fa-solid fa-pen"></i> Edit</a>
      <button id="md-close-btn" class="btn-back"><i class="fa-solid fa-xmark"></i> Close</button>
    </div>
  </div>
</div>

<%- include('layout/footer') %>
